<!DOCTYPE html>

<!--
  COLLABDESK PROTOTYPE:
    Patricia Saylor
    Divya Bajekal
    Jonathan Lui
    Benjamin Xie
    
-->
<html>

<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
    <title>CollabDesk</title>

    <!-- Load style sheets -->
    <link rel="stylesheet" href="jquery-ui-1.10.2/themes/smoothness/jquery-ui.css" />
    <link rel="stylesheet" href="bootstrap/css/bootstrap.css" />

    <!-- Load any supplemental Javascript libraries here -->
    <script type="text/javascript" src="jquery-ui-1.10.2/jquery-1.9.1.js"></script>
    <script type="text/javascript" src="jquery-ui-1.10.2/ui/jquery-ui.js"></script>
    <script type="text/javascript" src="bootstrap/js/bootstrap.js"></script>

    <!-- Load our own Javascript files and stylesheets here -->
    <script type="text/javascript" src="message.js"></script>
    <script type="text/javascript" src="database.js"></script>
    <script type="text/javascript" src="preloadData.js"></script>
    <script type="text/javascript" src="readMessage.js"></script>
    <script type="text/javascript" src="createMessage.js"></script>
    <script type="text/javascript" src="createReply.js"></script>
    <script type="text/javascript" src="templates.js"></script>
    <script type="text/javascript" src="search.js"></script>
    <script type="text/javascript" src="BrowsePane.js"></script>
    <script type="text/javascript" src="tooltip.js"></script>
    <link rel="stylesheet" href="styles.css" />

    <script type="text/javascript">
    $(document).ready(function(){
        console.debug("this is the read pane development page");

        // define global variables here
        var search = new Search();
        var browsePane;
        var newMessage = true;
        var replyId = 0;

        // view the preloaded database
        console.log(db);

        function readPaneReady() {
            console.debug('ready to work on read pane');
            // display a static message in the reading pane (until this is called from browsing pane)
            displayMessage(3);
            
        }

        function browsePaneReady() {
            console.debug('ready to work on browse pane');

            browsePane = new BrowsePane();
            browsePane.updateBrowsePane("message-table",db);

            $(".message").click(function(){
            var focusedId=$(this).attr("id"); //id of message that is clicked
            replyId = focusedId;
            displayMessage(focusedId);
            });

            $("#search-button").click(function(event){
                //console.log("clicked search button");
                var inp=$("#search-tbox").val();
                //console.log(inp);
                var messageIDs=search.getMessageIDs(inp,db);
                browsePane.updateSearchedBrowsePane("message-table",db, messageIDs);
                $(".ui-menu-item").hide()
            });

            $("#search-tbox").keydown(function(event){
                if(event.which==13){ //checking for 'enter'
                    var inp=$("#search-tbox").val();
                    //console.log("Listening to ENTER. input is "+inp+"matching messages are ");
                    var messageIDs=search.getMessageIDs(inp,db);
                    //console.log("messageIDs");
                    //console.log(search.getMessageIDs(inp,db));
                    browsePane.updateSearchedBrowsePane("message-table",db, messageIDs);
                    $(".ui-menu-item").hide()
                }

                if(inp==null){
                    browsePane.updateBrowsePane("message-table",db);
                }
            });

            $("#search-tbox").autocomplete({
                source: function(request, response){
                    //console.log(request.term);
                    if(request.term){
                        response(search.getMessageTitles(request.term.toLowerCase(),db));
                        var inp=$("#search-tbox").val();
                        var messageIDs=search.getMessageIDs(inp,db);
                        browsePane.updateSearchedBrowsePane("message-table",db, messageIDs);
                    }
                }
            });
        }

        function createPaneReady() {
            console.debug('ready to work on create pane');

            $("#cancelBtn").click(function() {
                newMessage = true;
                reset();
            });

            $("#cancelBtn").click(function(e) {
                if (e.which == 13) {
                    newMessage = true;
                    reset();
                }
            });

            $("#selectTemplate").change(function() {
                fillTemplate();
            });

            /*
            Submits a reply when the reply button is clicked in the reading pane
            */
            $(".replyButton").click(function() {
                newMessage = false;
                openReplyForm();
            });

            /*
            Submits the form when the user clicks the Submit button
            */
            $("#submitBtn").click(function() {
                console.log(newMessage);
                if (newMessage) {
                    submit();
                } else {
                    submitReply(replyId);
                    displayMessage(replyId);
                }
                newMessage = true;
                browsePane.updateBrowsePane("message-table",db);
            });

            /*
            Submits the form when the user has focus on the Submit button and presses enter
            */
            $("#submitBtn").keydown(function (e) {
                    if (e.which == 13) {
                        console.log($("#formTitle").html());
                        if ($("#formTitle").html() == "Create New Message") {
                        submit();
                    } else {
                        submitReply(replyId);
                        displayMessage(replyId);
                    }
                    newMessage = true;
                    browsePane.updateBrowsePane("message-table",db);

                }
            });
        }   

        readPaneReady();
        browsePaneReady();
        createPaneReady();
    });
    </script>

</head>

<body>

    <div class="loginHeader">
            <div class="floatLeft side">
                <h3 class="logo">CollabDesk</h3>
            </div>
            <div class="floatRight side">
                <div class="avatar side">
                    <img class="avatar" src="images/generic_avatar.jpg"/>
                </div>
                <h3 class="side username">Sally</h3>
            </div>
            <div class="clear"></div>
    </div>

    <div class="container-fluid">

        <!-- browse pane -->
            <div class="browse floatLeftNoPadding left white">
                <div id="browse-pane-inner">
                    <div class="row-fluid">
                        <div class="input-append span11 ">
                            <input type="text" class="input-block-level" id="search-tbox" autofocus />
                            <span class="add-on btn"><i class="icon-search icon-color" id="search-button"></i></span>
                        </div>
                    </div>
                    <div id="message-table">
                        <!--MESSAGES DYNAMICALLY ADDED HERE-->
                    </div>
                </div>
            </div>

        <!-- right side of layout: read and create -->      
        <div class="right">

        <!-- reading pane -->
            <div class="reading" id="reading-pane-wrapper">
                <div id="reading-pane-inner">
                    <div class="originalMsg section white">
                        <div class="originalMsgHeader">
                            <div class="originalMsgTitle"></div>
                            <div class="captain"><i class="icon-envelope icon-color"></i></div>
                            <div class="high_pri"><i class="icon-exclamation-sign icon-color"></i></div>
                            <div style="clear:right"></div>
                        </div>
                        <div class="originalMsgBody">
                            <div class="originalMsgDetails"></div>
                            <table>
                                <tr>
                                    <td><div class="authorPic"><img class="authorPic" src="images/generic_avatar.jpg"/></div></td>
                                    <td><div class="originalMsgDetailsText"></div></td>
                                </tr>
                            </table>
                            <div class="originalMsgText offset1"></div>
                        </div>
                        <div>
                            <table class="parentWidth">
                                <tr><td><div class="hashtags"></div></td></tr>
                                <tr><td align="right"><button type="button" class="replyButton btn btn-primary">Reply</button></td></tr>
                            </table>
                        </div>
                    </div>
                    <div class="replies"></div>
                </div>
            </div>
        </div>
            

</div>

</body>
</html>